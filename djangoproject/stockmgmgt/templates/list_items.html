{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Jekyll v4.0.1">
  <title>Home</title>

  <link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/navbar-fixed/">

  <!-- Bootstrap core CSS -->

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }

    body {
      min-height: 75rem;
      padding-top: 4.5rem;
    }
    .jumbotron{
      /* background-color:black; */
      opacity: ;
      position: absolute;
      left: 0;
    }
    .table {
      font-size: 13px;
      text-align: center;
      width: 95%;
      margin: auto;
    }

    .table tr:nth-child(odd) {
      background: #B8CAE4
    }

    .table tr:nth-child(even) {
      background: #dae5f4
    }

    th {
      background-color: #337ab7;
      color: white;
    }

    .display_table {
      border-bottom-right-radius: 20px;
      padding-left: 5px;
      padding-right: 5px;
      padding-bottom: 20px;
      box-shadow: 12px 12px 20px 6px #2e6da4;
    }

    .header {
      font-family: helvetica;
      color: #337ab7;
      font-size: 50px;
      text-align: center;
      width: 100%;
      text-shadow: 6px 6px 6px #c9c6c6;
      display: block;
      font-weight: bolder;
    }

    .success {
      list-style: none;
      background-color: #2e6da4;
      color: white;
      box-shadow: 12px 12px 12px #e61c66;
      text-align: center;
    }

    .mybutton {
      width: 100%;
    }

    table,
    th,
    td {
      /* border: 1px solid black; */
      border-collapse: collapse;
      width: 100%;
      text-align: justify;
    }
    .item-count{
      max-width: 50px;
    }
  </style>
  <!-- JavaScript -->
<script src="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
  <!-- Default theme -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"/>
  <!-- Semantic UI theme -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/semantic.min.css"/>
  <!-- Bootstrap theme -->
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css"/>
    <!-- Custom styles for this template -->
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  <script>
    $(window).load(function () {


      var table = document.getElementById("cart");
      var rows = table.rows;
      var total = 0;
      var cell;
      var column = 3;
      // Assume first row is headers, adjust as required
      // Assume last row is footer, addjust as required
      for (var i = 1, iLen = rows.length - 1; i < iLen; i++) {
        cell = rows[i].cells[column];
        total += Number(cell.textContent || cell.innerText);
      }
      document.getElementById("total").innerHTML = total.toFixed(2);

    });

    function get_cart_data(){
      pk = [];
      names = [];
      prices = [];
      quantity = [];
      
      var product_name = document.getElementsByClassName("item-name");
      for(let i = 0; i < product_name.length;i++){
        names.push(product_name[i].innerHTML);
      };
      
      var product_id = document.getElementsByClassName("product-id");
      for(let i = 0; i < product_id.length; i++){
        pk.push(product_id[i].innerHTML);
      };
      // alert(pk)
      
      var item_count = document.getElementsByClassName("item-count");
      for (i = 0 ; i < item_count.length; i++){
        quantity.push(item_count[i].value);
      };
      
      let a = Object.assign({}, ...pk.map((n, index) => ({[n]: quantity[index]})));
      var url = "http://127.0.0.1:8000/issue_items/";
      
      console.log(names)
      // if(name.length == 0){
      //   alert("No items placed in the cart")
      // }else{
      //   alert("The following items will be issues out " + names)
        
      // }
      
      alertify.confirm("The Following item(s) will be issued out ." + names,
        function(){
          alertify.success('Success. Reload page to view changes ');
          $.ajax({
            type: 'GET',
            url: url,
            data: a,
            dataType: 'json',
            success: shoppingCart.clearCart(),
            
           }).done(function (){
             location.reload(true);
           });
        },
        function(){
          alertify.error('Process was terminated');
        });

    };
  </script>

</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="/">WABCOM</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
      aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
        </li>
        {% if request.user.is_authenticated %}
        <li class="nav-item">
          <a class="nav-link" href="/list_items">Current Stock</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/add_items">Add Stock</a>
        </li>
        {% endif %}
      </ul>
      <ul class="navbar-nav">
        {% if request.user.is_authenticated %}
        <li><a href="/accounts/logout"><button class="btn btn-danger">{{ user }} | Logout</button></a></li>
        {% else %}
        <li><a href="/accounts/login">Login</a></li>
        {% endif %}
      </ul>
    </div>
  </nav>
  <main role="main" class="container">
    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}" {% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <div class="jumbotron">
      <div class="header">{{header}}</div>
      <div class="row">
        <div class="col-md-4">
          <div class="col-md-12">

            <div class="col-md-12 card mb-5 ">
              <!-- shopping cart -->
              <div class="card-header text-center bg-dark text-white" id='cart'>
                <h2>
                  <strong><i><b>Items Cart</b></i></strong>
                </h2>
              </div>
              <div>
                <ul id="show-cart" class="mt-5 container">
                    <li>???????</li>
                    <hr>
                </ul>
                <div class="ml-5"><b>Items In Cart : </b><span id="count-cart">X</span></div>
                <div class="ml-5"><b>Total : </b><span id="total-cart"></span><b> Ksh</b></div>

                <button class=" m-5  btn btn-danger" id="clear-cart">Clear Cart</button>
                <button class=" m-5  btn btn-warning" id="clear-cart" onclick="get_cart_data()">Issue Items</button>
            </div>

            </div>

            <div class="col-md-8">
              <form method="POST" action="">{% csrf_token %}
                {{form|crispy}}
                <input class=" btn btn-primary mybutton" type="submit" value="Search">
              </form>
            </div>
          </div>
        </div>
        <br>
        <div class="col-sm-7">
          <div class="display_table"
            style="border-bottom-right-radius: 20px; padding-left: 5px; padding-right: 5px; padding-bottom: 20px; box-shadow: 12px 12px 20px 6px #2e6da4;">
            <table class="table">
              <thead>
                <tr>
                  <th>COUNT</th>
                  <th>CATEGORY</th>
                  <th>ITEM NAME</th>
                  <th>QUANTITY IN STORE</th>
                  <th>PRICE(ksh)</th>
                  <th>TIMESTAMP</th>
                  <th>LAST UPDATED</th>
                  <th>DELETE ITEMS</th>
                </tr>
              </thead>
              {% for instance in queryset%}
              <tr>
                <td>{{forloop.counter}}</td>
                <td>{{instance.category}}</td>
                <td><a href="{% url 'update_items' instance.id %}">{{instance.item_name}}</a></td>
                <td><a href="">{{instance.quantity}}</a></td>
                <td>{{instance.price}}</td>
                <td><div>
                  <button class="btn btn-warning add-to-cart" data-id= {{instance.id}} data-price={{instance.price}} data-name={{instance.item_name}}><small><b>Add to cart </b></small></button>
                </div></td>
                <td>{{instance.last_updated}}</td>
                <td><a href="{% url 'delete_items' instance.id %}"><img
                      src="https://img.icons8.com/color/28/000000/delete-sign.png" /></a></td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>
      </div>
    </div>
    </div>
  </main>
  <script src="../static/js/js/shoppingCart.js"></script>

  <script>

      $(".add-to-cart").click(function(event){
          event.preventDefault();
          var name = $(this).attr("data-name");
          var price = Number($(this).attr("data-price"));
          var product_id = ($(this).attr("data-id"));
          console.log(product_id)
          shoppingCart.addItemToCart(name, price, 1, product_id);
          displayCart();
      });

      $("#clear-cart").click(function(event){
          shoppingCart.clearCart();
          displayCart();
      });

      function displayCart() {
          var cartArray = shoppingCart.listCart();
          console.log("we are here "+cartArray);
          var output = "";
          for (var i in cartArray) {
            output += "<div>"
                +"<p class='product-id'>"+cartArray[i].product_id+"</p>"
                +"<p class='item-name'>"+cartArray[i].name+"</p>"
                +" <input class='item-count' id='items-count' type='number' data-name='"
                +cartArray[i].name
                +"' value='"+cartArray[i].count+"' >"
                +" X " 
                +"<p class='item-price'>"+cartArray[i].price+"</p>"
                +" = "+"<b>"+cartArray[i].total+"</b>"
                +" <button class='plus-item' data-name='"
                +cartArray[i].name+"'>+</button>"
                +" <button class='subtract-item' data-name='"
                +cartArray[i].name+"'>-</button>"
                +" <button class='delete-item' data-name='"
                +cartArray[i].name+"'>X</button>"
                +"<hr>"
                +"</div>";
              }

          $("#show-cart").html(output);
          $("#count-cart").html( shoppingCart.countCart() );
          $("#total-cart").html( shoppingCart.totalCart() );
      }

      $("#show-cart").on("click", ".delete-item", function(event){
          var name = $(this).attr("data-name");
          shoppingCart.removeItemFromCartAll(name);
          displayCart();
      });

      $("#show-cart").on("click", ".subtract-item", function(event){
          var name = $(this).attr("data-name");
          shoppingCart.removeItemFromCart(name);
          displayCart();
      });

      $("#show-cart").on("click", ".plus-item", function(event){
          var name = $(this).attr("data-name");
          shoppingCart.addItemToCart(name, 0, 1);
          displayCart();
      });

      $("#show-cart").on("change", ".item-count", function(event){
          var name = $(this).attr("data-name");
          var count = Number($(this).val());
          shoppingCart.setCountForItem(name, count);
          displayCart();
      });


      displayCart();

  </script>
<!-- 
  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script> -->
  <script>window.jQuery || document.write('<script src="/docs/4.5/assets/js/vendor/jquery.slim.min.js"><\/script>')</script>
  <script src="/docs/4.5/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-1CmrxMRARb6aLqgBO7yyAxTOQE2AKb9GfXnEo760AUcUmFx3ibVJJAzGytlQcNXd"
    crossorigin="anonymous"></script> -->
</body>

</html>